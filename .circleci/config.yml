orbs:
  docker: circleci/docker@2.2.0
version: 2.1

commands:
  dependencies:
    steps:
      - run:
          name: Installing necessary packages
          command: |
            sudo apt update
            sudo apt install -y tar gzip curl software-properties-common
      - run:
          name: Installing ansible
          command: |
            sudo add-apt-repository --yes --update ppa:ansible/ansible
            sudo apt install ansible
executors:
  docker-publisher: 
    environment:
      IMAGE_NAME: kojokobi/app
    docker: # Each job requires specifying an executor
    # (either docker, macos, or machine), see
      # - image: circleci/node:latest
      - image: cimg/base:2021.04
        auth:
            username: $DOCKERHUB_USERNAME
            password: $DOCKERHUB_PASSWORD

jobs:
    lint-dockerfile:
      executor: docker/hadolint
      steps:
        - checkout
        - docker/hadolint:
            dockerfiles: ./Dockerfile
  
    build-dockerfile:
      executor: docker/machine
      steps:
        - checkout
        - docker/build:
            image: finalproject-img
            treat-warnings-as-errors: true

    publishLatestToHub: 
      executor: docker-publisher
      steps: 
        - checkout
        - setup_remote_docker
        - run: 
            name: Publish Docker Image to Docker Hub
            command: |
              echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
              docker build -t $IMAGE_NAME .
              docker push $IMAGE_NAME:latest

workflows:
  build-master:
    jobs:
       - publishLatestToHub